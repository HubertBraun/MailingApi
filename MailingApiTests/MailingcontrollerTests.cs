using MailingApi.Controllers;
using MailingApi.Layers;
using MailingApi.Models;
using MailingApiTests.Helper;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Diagnostics;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System.Collections.Generic;

namespace MailingApiTests
{
    [TestClass]
    public class MailingcontrollerTests
    {
        private static MailingController _controller;
        private static BusinessLayer _buisness;

        [ClassInitialize]
        public static void Initialize(TestContext _)
        {
            var options = new DbContextOptionsBuilder<MailingApiContext>().UseInMemoryDatabase(databaseName: "MailingcontrollerTests")
                .ConfigureWarnings(x => x.Ignore(InMemoryEventId.TransactionIgnoredWarning)).Options;
            var context = new MailingApiContext(options);
            var dataLayer = new DataLayer(context);
            _buisness = new BusinessLayer(dataLayer);
            _controller = new MailingController(_buisness);
            
            var user = BusinessTestHelper.CreateBusinessModelUser("TestUser", "Password");
            var userId = _buisness.RegisterUser(user);
            var emails = new List<string> { "a@a.com", "b@b.com" };
            var model = BusinessTestHelper.CreateBusinessModelGroup(userId, "testName", emails);
            var model2 = BusinessTestHelper.CreateBusinessModelGroup(userId, "testName2", emails);
            var modelToDelete1 = BusinessTestHelper.CreateBusinessModelGroup(userId, "testNameToDelete1", emails);
            var modelToDelete2 = BusinessTestHelper.CreateBusinessModelGroup(userId, "testNameToDelete2", emails);
            _buisness.SaveBusinessModelGroup(model);
            _buisness.SaveBusinessModelGroup(model2);
            _buisness.SaveBusinessModelGroup(modelToDelete1);
            _buisness.SaveBusinessModelGroup(modelToDelete2);
        }

        #region Get
        [DataRow(-1)]
        [DataRow(10)]
        [DataRow(1)]
        [DataRow(2)]
        [TestMethod]
        public void GetGroupByIdShoulReturnUnauthorized(int groupId)
        {
            var expected = new UnauthorizedResult();
            var actual = _controller.GetGroupById(groupId) as UnauthorizedResult;
            Assert.AreEqual(expected.GetType(), actual.GetType());
            Assert.AreEqual(expected.StatusCode, actual.StatusCode);
        }

        [DataRow(-1)]
        [DataRow(10)]
        [TestMethod]
        public void GetGroupByIdShoulReturnNotFound(int groupId)
        {
            var expected = new NotFoundResult();
            var actual = _controller.GetGroupById(groupId) as NotFoundResult;
            Assert.AreEqual(expected.GetType(), actual.GetType());
            Assert.AreEqual(expected.StatusCode, actual.StatusCode);
        }
        [TestMethod]
        [DataRow(1)]
        [DataRow(2)]
        public void GetGroupByIdShoulReturnOK(int groupId)
        {
            var expectedGroup = _buisness.GetBusinessModel(groupId);
            var actualGroup = (_controller.GetGroupById(groupId) as OkObjectResult).Value as BusinessModelGroup;
            BusinessTestHelper.CompareBusinessModelGroup(expectedGroup, actualGroup);
        }
        #endregion
        #region Post
        [TestMethod]
        public void PostNewGroupShoulReturnUnauthorized()
        {
            var emails = new List<string> { "email1Created", "email2Created" };
            var group = BusinessTestHelper.CreateBusinessModelGroup(1, "CreatedName", emails);

            var expected = new UnauthorizedResult();
            var actual = _controller.PostNewGroup(group) as UnauthorizedResult;
            Assert.AreEqual(expected.GetType(), actual.GetType());
            Assert.AreEqual(expected.StatusCode, actual.StatusCode);
        }
        [TestMethod]
        public void PostNewGroupShoulReturnCreated()
        {
            var emails = new List<string> { "email1Created", "email2Created" };
            var expectedGroup = BusinessTestHelper.CreateBusinessModelGroup(1, "CreatedName", emails);

            var result = _controller.PostNewGroup(expectedGroup) as CreatedResult;
            var id = (int)result.Value;
            var actualGroup = _buisness.GetBusinessModel(id);
            expectedGroup.Id = actualGroup.Id; // get generated by database Id
            BusinessTestHelper.CompareBusinessModelGroup(expectedGroup, actualGroup);
        }
        #endregion
        #region Put
        [TestMethod]
        public void PutShoulReturnCreated()
        {
        }

        [TestMethod]
        public void PutShoulReturnNotFound()
        {
        }

        [TestMethod]
        public void PutShoulReturnOK()
        {
        }
        #endregion
        #region Delete
        [DataRow(-1)]
        [DataRow(10)]
        [DataRow(3)]
        [DataRow(4)]
        [TestMethod]
        public void DeleteGroupShoulReturnUnauthorized(int groupId)
        {
            var expected = new UnauthorizedResult();
            var actual = _controller.DeleteGroup(groupId) as UnauthorizedResult;
            Assert.AreEqual(expected.GetType(), actual.GetType());
            Assert.AreEqual(expected.StatusCode, actual.StatusCode);
        }

        [DataRow(-1)]
        [DataRow(10)]
        [TestMethod]
        public void DeleteGroupShoulReturnNotFound(int groupId)
        {
            var expected = new NotFoundResult();
            var actual = _controller.DeleteGroup(groupId) as NotFoundResult;
            Assert.AreEqual(expected.GetType(), actual.GetType());
            Assert.AreEqual(expected.StatusCode, actual.StatusCode);
        }

        [DataRow(3)]
        [DataRow(4)]
        [TestMethod]
        public void DeleteGroupShoulReturnOK(int groupId)
        {
            var expected = new OkResult();
            var actual = _controller.DeleteGroup(groupId) as OkResult;
            Assert.AreEqual(expected.GetType(), actual.GetType());
            Assert.AreEqual(expected.StatusCode, actual.StatusCode);
            Assert.IsNull(_buisness.GetBusinessModel(groupId));
        }
        #endregion
    }
}
